/*! asmsimulator 19-07-2015 */
/*! asmsimulator 19-07-2015 */ var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(e){return{go:function(r){for(var a=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,t=/^[-+]?[0-9]+$/,i=/^[.A-Za-z]\w*$/,s=[],p={},o={},R={},E=r.split("\n"),l=function(e){if("0x"===e.slice(0,2))return parseInt(e.slice(2),16);if("0o"===e.slice(0,2))return parseInt(e.slice(2),8);if("b"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),2);if("d"===e.slice(e.length-1))return parseInt(e.slice(0,e.length-1),10);if(t.exec(e))return parseInt(e,10);throw"Invalid number format"},n=function(e){return"A"===(e=e.toUpperCase())?0:"B"===e?1:"C"===e?2:"D"===e?3:"SP"===e?4:void 0},d=function(e){e=e.toUpperCase();var r=0,a=0;if("A"===e[0])a=0;else if("B"===e[0])a=1;else if("C"===e[0])a=2;else if("D"===e[0])a=3;else{if("SP"!==e.slice(0,2))return;a=4}var t=1;if(4===a&&(t=2),"-"===e[t])r=-1;else{if("+"!==e[t])return;r=1}var i=r*parseInt(e.slice(t+1),10);if(-16>i||i>15)throw"offset must be a value between -16...+15";return 0>i&&(i=32+i),8*i+a},S=function(e,r,a){var t=n(e);if(void 0!==t)return{type:r,value:t};var i=D(e);if(void 0!==i)return{type:a,value:i};if("regaddress"===r&&void 0!==(t=d(e)))return{type:r,value:t};var s=l(e);if(isNaN(s))throw"Not a "+a+": "+s;if(0>s||s>255)throw a+" must have a value between 0-255";return{type:a,value:s}},D=function(e){return i.exec(e)?e:void 0},c=function(e){switch(e.slice(0,1)){case"[":return S(e.slice(1,e.length-1),"regaddress","address");case'"':for(var r=e.slice(1,e.length-1),a=[],t=0,i=r.length;i>t;t++)a.push(r.charCodeAt(t));return{type:"numbers",value:a};case"'":var s=e.slice(1,e.length-1);if(s.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:s.charCodeAt(0)};default:return S(e,"register","number")}},u=function(e,r){if(void 0!==r)throw e+": too many arguments"},g=0,G=E.length;G>g;g++)try{var f=a.exec(E[g]);if(void 0!==f[1]||void 0!==f[2]){if(void 0!==f[1]&&function(e){var r=e.toUpperCase();if(r in R)throw"Duplicate label: "+e;if("A"===r||"B"===r||"C"===r||"D"===r)throw"Label contains keyword: "+r;o[e]=s.length}(f[1]),void 0!==f[2]){var A,h,y,b=f[2].toUpperCase();switch("DB"!==b&&(p[s.length]=g),b){case"DB":if(A=c(f[3]),"number"===A.type)s.push(A.value);else{if("numbers"!==A.type)throw"DB does not support this operand";for(var k=0,v=A.value.length;v>k;k++)s.push(A.value[k])}break;case"HLT":u("HLT",f[3]),y=e.NONE,s.push(y);break;case"MOV":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.MOV_REG_TO_REG;else if("register"===A.type&&"address"===h.type)y=e.MOV_ADDRESS_TO_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.MOV_REGADDRESS_TO_REG;else if("address"===A.type&&"register"===h.type)y=e.MOV_REG_TO_ADDRESS;else if("regaddress"===A.type&&"register"===h.type)y=e.MOV_REG_TO_REGADDRESS;else if("register"===A.type&&"number"===h.type)y=e.MOV_NUMBER_TO_REG;else if("address"===A.type&&"number"===h.type)y=e.MOV_NUMBER_TO_ADDRESS;else{if("regaddress"!==A.type||"number"!==h.type)throw"MOV does not support this operands";y=e.MOV_NUMBER_TO_REGADDRESS}s.push(y,A.value,h.value);break;case"ADD":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.ADD_REG_TO_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.ADD_REGADDRESS_TO_REG;else if("register"===A.type&&"address"===h.type)y=e.ADD_ADDRESS_TO_REG;else{if("register"!==A.type||"number"!==h.type)throw"ADD does not support this operands";y=e.ADD_NUMBER_TO_REG}s.push(y,A.value,h.value);break;case"SUB":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.SUB_REG_FROM_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.SUB_REGADDRESS_FROM_REG;else if("register"===A.type&&"address"===h.type)y=e.SUB_ADDRESS_FROM_REG;else{if("register"!==A.type||"number"!==h.type)throw"SUB does not support this operands";y=e.SUB_NUMBER_FROM_REG}s.push(y,A.value,h.value);break;case"INC":if(A=c(f[3]),u("INC",f[7]),"register"!==A.type)throw"INC does not support this operand";y=e.INC_REG,s.push(y,A.value);break;case"DEC":if(A=c(f[3]),u("DEC",f[7]),"register"!==A.type)throw"DEC does not support this operand";y=e.DEC_REG,s.push(y,A.value);break;case"CMP":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.CMP_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.CMP_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=e.CMP_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw"CMP does not support this operands";y=e.CMP_NUMBER_WITH_REG}s.push(y,A.value,h.value);break;case"JMP":if(A=c(f[3]),u("JMP",f[7]),"register"===A.type)y=e.JMP_REGADDRESS;else{if("number"!==A.type)throw"JMP does not support this operands";y=e.JMP_ADDRESS}s.push(y,A.value);break;case"JC":case"JB":case"JNAE":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.JC_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=e.JC_ADDRESS}s.push(y,A.value);break;case"JNC":case"JNB":case"JAE":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.JNC_REGADDRESS;else{if("number"!==A.type)throw b+"does not support this operand";y=e.JNC_ADDRESS}s.push(y,A.value);break;case"JZ":case"JE":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.JZ_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=e.JZ_ADDRESS}s.push(y,A.value);break;case"JNZ":case"JNE":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.JNZ_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=e.JNZ_ADDRESS}s.push(y,A.value);break;case"JA":case"JNBE":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.JA_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=e.JA_ADDRESS}s.push(y,A.value);break;case"JNA":case"JBE":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.JNA_REGADDRESS;else{if("number"!==A.type)throw b+" does not support this operand";y=e.JNA_ADDRESS}s.push(y,A.value);break;case"PUSH":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.PUSH_REG;else if("regaddress"===A.type)y=e.PUSH_REGADDRESS;else if("address"===A.type)y=e.PUSH_ADDRESS;else{if("number"!==A.type)throw"PUSH does not support this operand";y=e.PUSH_NUMBER}s.push(y,A.value);break;case"POP":if(A=c(f[3]),u(b,f[7]),"register"!==A.type)throw"PUSH does not support this operand";y=e.POP_REG,s.push(y,A.value);break;case"CALL":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.CALL_REGADDRESS;else{if("number"!==A.type)throw"CALL does not support this operand";y=e.CALL_ADDRESS}s.push(y,A.value);break;case"RET":u(b,f[3]),y=e.RET,s.push(y);break;case"MUL":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.MUL_REG;else if("regaddress"===A.type)y=e.MUL_REGADDRESS;else if("address"===A.type)y=e.MUL_ADDRESS;else{if("number"!==A.type)throw"MULL does not support this operand";y=e.MUL_NUMBER}s.push(y,A.value);break;case"DIV":if(A=c(f[3]),u(b,f[7]),"register"===A.type)y=e.DIV_REG;else if("regaddress"===A.type)y=e.DIV_REGADDRESS;else if("address"===A.type)y=e.DIV_ADDRESS;else{if("number"!==A.type)throw"DIV does not support this operand";y=e.DIV_NUMBER}s.push(y,A.value);break;case"AND":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.AND_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.AND_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=e.AND_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw"AND does not support this operands";y=e.AND_NUMBER_WITH_REG}s.push(y,A.value,h.value);break;case"OR":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.OR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.OR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=e.OR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw"OR does not support this operands";y=e.OR_NUMBER_WITH_REG}s.push(y,A.value,h.value);break;case"XOR":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.XOR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.XOR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=e.XOR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw"XOR does not support this operands";y=e.XOR_NUMBER_WITH_REG}s.push(y,A.value,h.value);break;case"NOT":if(A=c(f[3]),u(b,f[7]),"register"!==A.type)throw"NOT does not support this operand";y=e.NOT_REG,s.push(y,A.value);break;case"SHL":case"SAL":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.SHL_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.SHL_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=e.SHL_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw b+" does not support this operands";y=e.SHL_NUMBER_WITH_REG}s.push(y,A.value,h.value);break;case"SHR":case"SAR":if(A=c(f[3]),h=c(f[7]),"register"===A.type&&"register"===h.type)y=e.SHR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===h.type)y=e.SHR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===h.type)y=e.SHR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==h.type)throw b+" does not support this operands";y=e.SHR_NUMBER_WITH_REG}s.push(y,A.value,h.value);break;default:throw"Invalid instruction: "+f[2]}}}else{var M=E[g].trim();if(""!==M&&";"!==M.slice(0,1))throw"Syntax error"}}catch(T){throw{error:T,line:g}}for(g=0,G=s.length;G>g;g++)if(!angular.isNumber(s[g])){if(!(s[g]in o))throw{error:"Undefined label: "+s[g]};s[g]=o[s[g]]}return{code:s,mapping:p,labels:o}}}},]),app.service("cpu",["opcodes","memory",function(e,r){var a={step:function(){var a=this;if(!0===a.fault)throw"FAULT. Reset to continue.";try{var t=function(e){if(0>e||e>=a.gpr.length)throw"Invalid register: "+e;return e},i=function(e){if(0>e||e>=1+a.gpr.length)throw"Invalid register: "+e;return e},s=function(e,r){if(e>=0&&e<a.gpr.length)a.gpr[e]=r;else{if(e!=a.gpr.length)throw"Invalid register: "+e;if(a.sp=r,a.sp<a.minSP)throw"Stack overflow";if(a.sp>a.maxSP)throw"Stack underflow"}},p=function(e){if(e>=0&&e<a.gpr.length)return a.gpr[e];if(e==a.gpr.length)return a.sp;throw"Invalid register: "+e},o=function(e){var r,t=e%8;r=t<a.gpr.length?a.gpr[t]:a.sp;var i=Math.floor(e/8);return i>15&&(i-=32),r+i},R=function(e){return a.zero=!1,a.carry=!1,e>=256?(a.carry=!0,e%=256):0===e?a.zero=!0:0>e&&(a.carry=!0,e=256- -e%256),e},E=function(e){if(0>e||e>=r.data.length)throw"IP outside memory";a.ip=e},l=function(e){if(r.store(a.sp--,e),a.sp<a.minSP)throw"Stack overflow"},n=function(){var e=r.load(++a.sp);if(a.sp>a.maxSP)throw"Stack underflow";return e},d=function(e){if(0===e)throw"Division by 0";return Math.floor(a.gpr[0]/e)};if(a.ip<0||a.ip>=r.data.length)throw"Instruction pointer is outside of memory";var S,D,c,u,g,G=r.load(a.ip);switch(G){case e.NONE:return!1;case e.MOV_REG_TO_REG:S=i(r.load(++a.ip)),D=i(r.load(++a.ip)),s(S,p(D)),a.ip++;break;case e.MOV_ADDRESS_TO_REG:S=i(r.load(++a.ip)),c=r.load(++a.ip),s(S,r.load(c)),a.ip++;break;case e.MOV_REGADDRESS_TO_REG:S=i(r.load(++a.ip)),D=r.load(++a.ip),s(S,r.load(o(D))),a.ip++;break;case e.MOV_REG_TO_ADDRESS:u=r.load(++a.ip),D=i(r.load(++a.ip)),r.store(u,p(D)),a.ip++;break;case e.MOV_REG_TO_REGADDRESS:S=r.load(++a.ip),D=i(r.load(++a.ip)),r.store(o(S),p(D)),a.ip++;break;case e.MOV_NUMBER_TO_REG:S=i(r.load(++a.ip)),g=r.load(++a.ip),s(S,g),a.ip++;break;case e.MOV_NUMBER_TO_ADDRESS:u=r.load(++a.ip),g=r.load(++a.ip),r.store(u,g),a.ip++;break;case e.MOV_NUMBER_TO_REGADDRESS:S=r.load(++a.ip),g=r.load(++a.ip),r.store(o(S),g),a.ip++;break;case e.ADD_REG_TO_REG:S=i(r.load(++a.ip)),D=i(r.load(++a.ip)),s(S,R(p(S)+p(D))),a.ip++;break;case e.ADD_REGADDRESS_TO_REG:S=i(r.load(++a.ip)),D=r.load(++a.ip),s(S,R(p(S)+r.load(o(D)))),a.ip++;break;case e.ADD_ADDRESS_TO_REG:S=i(r.load(++a.ip)),c=r.load(++a.ip),s(S,R(p(S)+r.load(c))),a.ip++;break;case e.ADD_NUMBER_TO_REG:S=i(r.load(++a.ip)),g=r.load(++a.ip),s(S,R(p(S)+g)),a.ip++;break;case e.SUB_REG_FROM_REG:S=i(r.load(++a.ip)),D=i(r.load(++a.ip)),s(S,R(p(S)-a.gpr[D])),a.ip++;break;case e.SUB_REGADDRESS_FROM_REG:S=i(r.load(++a.ip)),D=r.load(++a.ip),s(S,R(p(S)-r.load(o(D)))),a.ip++;break;case e.SUB_ADDRESS_FROM_REG:S=i(r.load(++a.ip)),c=r.load(++a.ip),s(S,R(p(S)-r.load(c))),a.ip++;break;case e.SUB_NUMBER_FROM_REG:S=i(r.load(++a.ip)),g=r.load(++a.ip),s(S,R(p(S)-g)),a.ip++;break;case e.INC_REG:S=i(r.load(++a.ip)),s(S,R(p(S)+1)),a.ip++;break;case e.DEC_REG:S=i(r.load(++a.ip)),s(S,R(p(S)-1)),a.ip++;break;case e.CMP_REG_WITH_REG:S=i(r.load(++a.ip)),D=i(r.load(++a.ip)),R(p(S)-p(D)),a.ip++;break;case e.CMP_REGADDRESS_WITH_REG:S=i(r.load(++a.ip)),D=r.load(++a.ip),R(p(S)-r.load(o(D))),a.ip++;break;case e.CMP_ADDRESS_WITH_REG:S=i(r.load(++a.ip)),c=r.load(++a.ip),R(p(S)-r.load(c)),a.ip++;break;case e.CMP_NUMBER_WITH_REG:S=i(r.load(++a.ip)),g=r.load(++a.ip),R(p(S)-g),a.ip++;break;case e.JMP_REGADDRESS:S=t(r.load(++a.ip)),E(a.gpr[S]);break;case e.JMP_ADDRESS:g=r.load(++a.ip),E(g);break;case e.JC_REGADDRESS:S=t(r.load(++a.ip)),a.carry?E(a.gpr[S]):a.ip++;break;case e.JC_ADDRESS:g=r.load(++a.ip),a.carry?E(g):a.ip++;break;case e.JNC_REGADDRESS:S=t(r.load(++a.ip)),a.carry?a.ip++:E(a.gpr[S]);break;case e.JNC_ADDRESS:g=r.load(++a.ip),a.carry?a.ip++:E(g);break;case e.JZ_REGADDRESS:S=t(r.load(++a.ip)),a.zero?E(a.gpr[S]):a.ip++;break;case e.JZ_ADDRESS:g=r.load(++a.ip),a.zero?E(g):a.ip++;break;case e.JNZ_REGADDRESS:S=t(r.load(++a.ip)),a.zero?a.ip++:E(a.gpr[S]);break;case e.JNZ_ADDRESS:g=r.load(++a.ip),a.zero?a.ip++:E(g);break;case e.JA_REGADDRESS:S=t(r.load(++a.ip)),a.zero||a.carry?a.ip++:E(a.gpr[S]);break;case e.JA_ADDRESS:g=r.load(++a.ip),a.zero||a.carry?a.ip++:E(g);break;case e.JNA_REGADDRESS:S=t(r.load(++a.ip)),a.zero||a.carry?E(a.gpr[S]):a.ip++;break;case e.JNA_ADDRESS:g=r.load(++a.ip),a.zero||a.carry?E(g):a.ip++;break;case e.PUSH_REG:D=t(r.load(++a.ip)),l(a.gpr[D]),a.ip++;break;case e.PUSH_REGADDRESS:D=r.load(++a.ip),l(r.load(o(D))),a.ip++;break;case e.PUSH_ADDRESS:c=r.load(++a.ip),l(r.load(c)),a.ip++;break;case e.PUSH_NUMBER:g=r.load(++a.ip),l(g),a.ip++;break;case e.POP_REG:S=t(r.load(++a.ip)),a.gpr[S]=n(),a.ip++;break;case e.CALL_REGADDRESS:S=t(r.load(++a.ip)),l(a.ip+1),E(a.gpr[S]);break;case e.CALL_ADDRESS:g=r.load(++a.ip),l(a.ip+1),E(g);break;case e.RET:E(n());break;case e.MUL_REG:D=t(r.load(++a.ip)),a.gpr[0]=R(a.gpr[0]*a.gpr[D]),a.ip++;break;case e.MUL_REGADDRESS:D=r.load(++a.ip),a.gpr[0]=R(a.gpr[0]*r.load(o(D))),a.ip++;break;case e.MUL_ADDRESS:c=r.load(++a.ip),a.gpr[0]=R(a.gpr[0]*r.load(c)),a.ip++;break;case e.MUL_NUMBER:g=r.load(++a.ip),a.gpr[0]=R(a.gpr[0]*g),a.ip++;break;case e.DIV_REG:D=t(r.load(++a.ip)),a.gpr[0]=R(d(a.gpr[D])),a.ip++;break;case e.DIV_REGADDRESS:D=r.load(++a.ip),a.gpr[0]=R(d(r.load(o(D)))),a.ip++;break;case e.DIV_ADDRESS:c=r.load(++a.ip),a.gpr[0]=R(d(r.load(c))),a.ip++;break;case e.DIV_NUMBER:g=r.load(++a.ip),a.gpr[0]=R(d(g)),a.ip++;break;case e.AND_REG_WITH_REG:S=t(r.load(++a.ip)),D=t(r.load(++a.ip)),a.gpr[S]=R(a.gpr[S]&a.gpr[D]),a.ip++;break;case e.AND_REGADDRESS_WITH_REG:S=t(r.load(++a.ip)),D=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]&r.load(o(D))),a.ip++;break;case e.AND_ADDRESS_WITH_REG:S=t(r.load(++a.ip)),c=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]&r.load(c)),a.ip++;break;case e.AND_NUMBER_WITH_REG:S=t(r.load(++a.ip)),g=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]&g),a.ip++;break;case e.OR_REG_WITH_REG:S=t(r.load(++a.ip)),D=t(r.load(++a.ip)),a.gpr[S]=R(a.gpr[S]|a.gpr[D]),a.ip++;break;case e.OR_REGADDRESS_WITH_REG:S=t(r.load(++a.ip)),D=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]|r.load(o(D))),a.ip++;break;case e.OR_ADDRESS_WITH_REG:S=t(r.load(++a.ip)),c=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]|r.load(c)),a.ip++;break;case e.OR_NUMBER_WITH_REG:S=t(r.load(++a.ip)),g=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]|g),a.ip++;break;case e.XOR_REG_WITH_REG:S=t(r.load(++a.ip)),D=t(r.load(++a.ip)),a.gpr[S]=R(a.gpr[S]^a.gpr[D]),a.ip++;break;case e.XOR_REGADDRESS_WITH_REG:S=t(r.load(++a.ip)),D=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]^r.load(o(D))),a.ip++;break;case e.XOR_ADDRESS_WITH_REG:S=t(r.load(++a.ip)),c=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]^r.load(c)),a.ip++;break;case e.XOR_NUMBER_WITH_REG:S=t(r.load(++a.ip)),g=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]^g),a.ip++;break;case e.NOT_REG:S=t(r.load(++a.ip)),a.gpr[S]=R(~a.gpr[S]),a.ip++;break;case e.SHL_REG_WITH_REG:S=t(r.load(++a.ip)),D=t(r.load(++a.ip)),a.gpr[S]=R(a.gpr[S]<<a.gpr[D]),a.ip++;break;case e.SHL_REGADDRESS_WITH_REG:S=t(r.load(++a.ip)),D=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]<<r.load(o(D))),a.ip++;break;case e.SHL_ADDRESS_WITH_REG:S=t(r.load(++a.ip)),c=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]<<r.load(c)),a.ip++;break;case e.SHL_NUMBER_WITH_REG:S=t(r.load(++a.ip)),g=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]<<g),a.ip++;break;case e.SHR_REG_WITH_REG:S=t(r.load(++a.ip)),D=t(r.load(++a.ip)),a.gpr[S]=R(a.gpr[S]>>>a.gpr[D]),a.ip++;break;case e.SHR_REGADDRESS_WITH_REG:S=t(r.load(++a.ip)),D=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]>>>r.load(o(D))),a.ip++;break;case e.SHR_ADDRESS_WITH_REG:S=t(r.load(++a.ip)),c=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]>>>r.load(c)),a.ip++;break;case e.SHR_NUMBER_WITH_REG:S=t(r.load(++a.ip)),g=r.load(++a.ip),a.gpr[S]=R(a.gpr[S]>>>g),a.ip++;break;default:throw"Invalid op code: "+G}return!0}catch(f){throw a.fault=!0,f}},reset:function(){var e=this;e.maxSP=231,e.minSP=0,e.gpr=[0,0,0,0],e.sp=e.maxSP,e.ip=0,e.zero=!1,e.carry=!1,e.fault=!1}};return a.reset(),a},]),app.service("memory",[function(){var e={data:Array(256),lastAccess:-1,load:function(e){var r=this;if(0>e||e>=r.data.length)throw"Memory access violation at "+e;return r.lastAccess=e,r.data[e]},store:function(e,r){var a=this;if(0>e||e>=a.data.length)throw"Memory access violation at "+e;a.lastAccess=e,a.data[e]=r},reset:function(){var e=this;e.lastAccess=-1;for(var r=0,a=e.data.length;a>r;r++)e.data[r]=0}};return e.reset(),e},]),app.service("opcodes",[function(){return{NONE:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97}},]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(e,r,a,t,i,s){var p;r.memory=i,r.cpu=t,r.error="",r.isRunning=!1,r.displayHex=!0,r.displayInstr=!0,r.displayA=!1,r.displayB=!1,r.displayC=!1,r.displayD=!1,r.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"},],r.speed=4,r.outputStartIndex=232,r.code=";Write you programs here!",r.reset=function(){t.reset(),i.reset(),r.error="",r.selectedLine=-1},r.executeStep=function(){r.checkPrgrmLoaded()||r.assemble();try{var e=t.step();return t.ip in r.mapping&&(r.selectedLine=r.mapping[t.ip]),e}catch(a){return r.error=a,!1}},r.run=function(){r.checkPrgrmLoaded()||r.assemble(),r.isRunning=!0,p=a(function(){!0===r.executeStep()?r.run():r.isRunning=!1},1e3/r.speed)},r.stop=function(){a.cancel(p),r.isRunning=!1},r.checkPrgrmLoaded=function(){for(var e=0,r=i.data.length;r>e;e++)if(0!==i.data[e])return!0;return!1},r.getChar=function(e){var r=String.fromCharCode(e);return""===r.trim()?"  ":r},r.assemble=function(){try{r.reset();var e=s.go(r.code);r.mapping=e.mapping;var a=e.code;if(r.labels=e.labels,a.length>i.data.length)throw"Binary code does not fit into the memory. Max "+i.data.length+" bytes are allowed";for(var t=0,p=a.length;p>t;t++)i.data[t]=a[t]}catch(o){void 0!==o.line?(r.error=o.line+" | "+o.error,r.selectedLine=o.line):r.error=o.error}},r.jumpToLine=function(a){e[0].getElementById("sourceCode").scrollIntoView(),r.selectedLine=r.mapping[a]},r.isInstruction=function(e){return void 0!==r.mapping&&void 0!==r.mapping[e]&&r.displayInstr},r.getMemoryCellCss=function(e){return e>=r.outputStartIndex?"output-bg":r.isInstruction(e)?"instr-bg":e>t.sp&&e<=t.maxSP?"stack-bg":""},r.getMemoryInnerCellCss=function(e){return e===t.ip?"marker marker-ip":e===t.sp?"marker marker-sp":e===t.gpr[0]&&r.displayA?"marker marker-a":e===t.gpr[1]&&r.displayB?"marker marker-b":e===t.gpr[2]&&r.displayC?"marker marker-c":e===t.gpr[3]&&r.displayD?"marker marker-d":""}},]),app.filter("flag",function(){return function(e){return e.toString().toUpperCase()}}),app.filter("number",function(){return function(e,r){if(r){var a=e.toString(16).toUpperCase();return 1==a.length?"0"+a:a}return e.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(e,r,a,t){e.$watch("selectedLine",function(){if(e.selectedLine>=0){for(var a=r[0].value.split("\n"),t=0,i=0;i<a.length&&i!=e.selectedLine;i++)t+=a[i].length+1;var s=a[e.selectedLine].length+t;if(void 0!==r[0].selectionStart&&(r[0].focus(),r[0].selectionStart=t,r[0].selectionEnd=s),document.selection&&document.selection.createRange){r[0].focus(),r[0].select();var p=document.selection.createRange();p.collapse(!0),p.moveEnd("character",s),p.moveStart("character",t),p.select()}}})}}},]),app.filter("startFrom",function(){return function(e,r){return r=+r,e.slice(r)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(e,r,a,t){r.bind("keydown",function(e){if(9===e.keyCode){var r=this.value,a=this.selectionStart,t=this.selectionEnd;return this.value=r.substring(0,a)+"	"+r.substring(t),this.selectionStart=this.selectionEnd=a+1,e.preventDefault(),!1}})}}},]);
